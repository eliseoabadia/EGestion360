@using EG.Web.Extensions
@using EG.Web.Helpers
@using EG.Web.Models.Configuration
@using EG.Web.Services
@using EG.Web.Contracs.Configuration
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components
@using MudBlazor

@inject INavigateService NavigateService
@inject NavigationManager NavigationManager
@inject AuthService AuthService
@inject ISnackbar Snackbar
@inject IJSRuntime _jsRuntime

<AuthorizeView>
    <Authorized>
        <MudNavMenu>
            @if (Items != null)
            {
                @foreach (var item in Items.OrderBy(m => m.Orden))
                {
                    if (item.Children?.Any() == true)
                    {
                        <MudNavGroup Title="@item.Nombre"
                                     Icon="@GetIcon(item.ImageUrl)"
                                     Expanded="@GetExpandedState(item.PkidMenu)"
                                     ExpandedChanged="@(EventCallback.Factory.Create<bool>(this, (v) => SetExpandedState(item.PkidMenu, v)))">
                            <NavMenuItems Items="@item.Children"
                                          GetIcon="GetIcon"
                                          ExpandedStates="expandedStates"
                                          OnExpandedChanged="@(EventCallback.Factory.Create<(long?, bool)>(this, (data) => SetExpandedState(data.Item1, data.Item2)))" />
                        </MudNavGroup>
                    }
                    else
                    {
                        <MudNavLink Href="@item.Ruta"
                                    Match="@(item.Ruta == "/" ? NavLinkMatch.All : NavLinkMatch.Prefix)"
                                    Icon="@GetIcon(item.ImageUrl)">
                            @item.Nombre
                        </MudNavLink>
                    }
                }
            }
        </MudNavMenu>
    </Authorized>
</AuthorizeView>

@code {
    private bool loading = false;
    private bool _isInitialized = false;
    private int _userId;
    private string _token = string.Empty;

    [Parameter]
    public List<MenuItem> Items { get; set; } = new();

    private Dictionary<long, bool> expandedStates = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isInitialized)
        {
            _isInitialized = true;
            await LoadMenuAsync();
        }
    }

    private async Task LoadMenuAsync()
    {
        var uri = NavigationManager.ToBaseRelativePath(NavigationManager.Uri).TrimEnd('/');
        if (uri == "login" || uri.StartsWith("login?"))
            return;

        loading = true;
        StateHasChanged();

        try
        {
            string? rawToken = await GetLocalStorageItemWithTimeoutAsync("authToken", 2000);

            if (string.IsNullOrWhiteSpace(rawToken))
            {
                NavigationManager.NavigateTo("/login", forceLoad: true);
                return;
            }

            rawToken = rawToken.Trim();
            if ((rawToken.StartsWith("\"") && rawToken.EndsWith("\"")) ||
                (rawToken.StartsWith("'") && rawToken.EndsWith("'")))
            {
                rawToken = rawToken.Substring(1, rawToken.Length - 2);
            }

            _token = rawToken.StartsWith("Bearer ", StringComparison.OrdinalIgnoreCase)
                ? rawToken.Substring("Bearer ".Length)
                : rawToken;

            _userId = await GetUserIdAsync();

            if (_userId == 0)
            {
                NavigationManager.NavigateTo("/login", forceLoad: true);
                return;
            }

            var result = await NavigateService.GetMenuAsync(_userId);

            if (result?.Items?.Any() == true)
            {
                Items = result.Items;
                InitializeExpandedStates();
            }
            else
            {
                NavigationManager.NavigateTo("/login", forceLoad: true);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar datos del usuario: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private void InitializeExpandedStates()
    {
        foreach (var item in Items.Where(m => m.Children?.Any() == true))
        {
            if (!expandedStates.ContainsKey(item.PkidMenu))
            {
                expandedStates[item.PkidMenu] = false;
            }
        }
    }

    private async Task<int> GetUserIdAsync()
    {
        var userId = await AuthService.GetUserIdAsync();
        if (userId != 0) return userId;

        var parsed = ParseUserIdFromToken(_token);
        if (parsed.HasValue) return parsed.Value;

        var stored = await GetLocalStorageItemWithTimeoutAsync("userId", 1000);
        if (!string.IsNullOrEmpty(stored) && int.TryParse(stored, out var sId))
            return sId;

        return 0;
    }

    private async Task<string?> GetLocalStorageItemWithTimeoutAsync(string key, int timeoutMs = 1500)
    {
        try
        {
            var task = _jsRuntime.InvokeAsync<string>("localStorage.getItem", key).AsTask();
            var completed = await Task.WhenAny(task, Task.Delay(timeoutMs));
            return completed == task ? await task : null;
        }
        catch
        {
            return null;
        }
    }

    private static int? ParseUserIdFromToken(string jwt)
    {
        try
        {
            var parts = jwt.Split('.');
            if (parts.Length < 2) return null;

            string payload = parts[1];
            int mod4 = payload.Length % 4;
            if (mod4 > 0) payload += new string('=', 4 - mod4);

            var bytes = Convert.FromBase64String(payload);
            var json = System.Text.Encoding.UTF8.GetString(bytes);
            using var doc = System.Text.Json.JsonDocument.Parse(json);
            var root = doc.RootElement;

            string[] keys = { "UserId", "userId", "id", "Id", "sub", "nameid", "pkIdUsuario" };
            foreach (var prop in root.EnumerateObject())
            {
                if (keys.Any(k => string.Equals(prop.Name, k, StringComparison.OrdinalIgnoreCase)))
                {
                    var val = prop.Value.GetString() ?? prop.Value.ToString();
                    if (int.TryParse(val, out var numeric)) return numeric;

                    var match = System.Text.RegularExpressions.Regex.Match(val ?? "", @"\d+");
                    if (match.Success && int.TryParse(match.Value, out var numeric2))
                        return numeric2;
                }
            }
        }
        catch { }
        return null;
    }

    private bool GetExpandedState(long? pkId)
    {
        return pkId.HasValue && expandedStates.TryGetValue(pkId.Value, out var state) ? state : false;
    }

    private void SetExpandedState(long? pkId, bool expanded)
    {
        if (pkId.HasValue)
        {
            expandedStates[pkId.Value] = expanded;
            StateHasChanged();
        }
    }

    private static readonly Dictionary<string, string> _iconMap = IconosDisponibles.Lista
        .GroupBy(x => x.Valor)
        .ToDictionary(g => g.Key, g => g.First().MaterialIcon);

    private string GetIcon(string imageUrl)
    {
        if (string.IsNullOrEmpty(imageUrl))
            return Icons.Material.Filled.Info;

        return _iconMap.TryGetValue(imageUrl, out var icon) ? icon : Icons.Material.Filled.Info;
    }
}