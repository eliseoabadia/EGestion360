@inherits LayoutComponentBase
@inject NavigationManager NavigationManager

<link href="css/menu-overlays.css" rel="stylesheet" />
<script src="~/js/download.js"></script>

<MudThemeProvider Theme="@_theme" IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1" Class="app-bar">
        <MudIconButton Icon="@(_drawerOpen? Icons.Material.Filled.MenuOpen : Icons.Material.Filled.Menu)"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="@((e) => DrawerToggle())" />
        <MudText Typo="Typo.h5" Class="ml-3 app-title">GE.WebApp</MudText>
        <MudSpacer />

        <!-- Selector único con las tres opciones -->
        <MudMenu Icon="@Icons.Material.Filled.ColorLens"
                 Color="Color.Inherit"
                 AnchorOrigin="Origin.TopRight"
                 TransformOrigin="Origin.TopRight"
                 Class="theme-menu">
            @foreach (var option in Enum.GetValues<ThemeOption>())
            {
                <MudMenuItem OnClick="@(() => SelectThemeOption(option))">
                    <div class="d-flex align-center">
                        @if (option == ThemeOption.Claro)
                        {
                            <MudIcon Icon="@Icons.Material.Outlined.LightMode" Class="mr-2" Size="Size.Small" />
                        }
                        else if (option == ThemeOption.Oscuro)
                        {
                            <MudIcon Icon="@Icons.Material.Outlined.DarkMode" Class="mr-2" Size="Size.Small" />
                        }
                        else if (option == ThemeOption.Morena)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Park" Class="mr-2" Size="Size.Small" Style="color: #8B4513;" />
                        }
                        @option.ToString()
                    </div>
                </MudMenuItem>
            }
        </MudMenu>

        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopRight">
            <MudMenuItem OnClick="@Logout">Cerrar sesión</MudMenuItem>
        </MudMenu>
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen"
               ClipMode="DrawerClipMode.Always"
               Elevation="2"
               Width="220px"
               Class="custom-drawer">
        <DynamicMenu />
    </MudDrawer>

    <MudMainContent Class="main-content">
        <div class="content-wrapper">
            @Body
        </div>
    </MudMainContent>
</MudLayout>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>

@code {
    // Enumerador con las tres opciones
    public enum ThemeOption
    {
        Claro,
        Oscuro,
        Morena
    }

    private ThemeOption _selectedThemeOption { get; set; } = ThemeOption.Oscuro; // Cambiado a Oscuro por defecto

    private bool _drawerOpen = true;
    private bool _isDarkMode = true; // true = oscuro, false = claro
    private string _selectedTheme = "default"; // "default" o "morena"
    private MudTheme _theme = new MudTheme(); // Inicializamos aquí

    private async Task Logout()
    {
        NavigationManager.NavigateTo("/login", forceLoad: true);
        await Task.CompletedTask;
    }

    private async Task SelectThemeOption(ThemeOption option)
    {
        _selectedThemeOption = option;
        OnThemeOptionChanged(); // Llama al método que tiene la lógica de cambio
        StateHasChanged();
    }

    private void OnThemeOptionChanged()
    {
        switch (_selectedThemeOption)
        {
            case ThemeOption.Claro:
                _isDarkMode = false;
                _selectedTheme = "default";
                break;
            case ThemeOption.Oscuro:
                _isDarkMode = true;
                _selectedTheme = "default";
                break;
            case ThemeOption.Morena:
                _isDarkMode = true; // Morena usa modo oscuro por defecto para mejor contraste
                _selectedTheme = "morena";
                break;
        }

        LoadTheme();
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        // Inicializar con el tema por defecto (Oscuro)
        OnThemeOptionChanged();
    }

    private void LoadTheme()
    {
        _theme = new()
        {
            PaletteLight = GetLightPalette(),
            PaletteDark = GetDarkPalette(),
            LayoutProperties = new LayoutProperties()
            {
                DefaultBorderRadius = "10px"
            },
            Typography = new Typography()
            {
                Default = new DefaultTypography()
                {
                    FontFamily = new[] { "Segoe UI", "Roboto", "Arial", "sans-serif" },
                    FontSize = "0.95rem"
                },
                H5 = new H5Typography()
                {
                    FontWeight = "700",
                    FontSize = "1.4rem"
                },
                Overline = new OverlineTypography()
                {
                    FontSize = "0.8rem",
                    FontWeight = "500"
                },
                Subtitle2 = new Subtitle2Typography()
                {
                    FontSize = "0.875rem",
                    FontWeight = "500"
                }
            }
        };
    }

    private PaletteLight GetLightPalette()
    {
        // Para el modo claro solo aplica si es tema default
        if (_selectedTheme == "default" && _selectedThemeOption == ThemeOption.Claro)
        {
            return new PaletteLight()
            {
                Primary = "#4A6EF1",
                Secondary = "#F5A623",
                Tertiary = "#50C878",
                Background = "#F9FAFB",
                Surface = "#FFFFFF",
                AppbarBackground = "#FFFFFFCC",
                AppbarText = "#1F2937",
                DrawerBackground = "#F3F4F6",
                DrawerText = "#1F2937",
                DrawerIcon = "#4A6EF1",
                TextPrimary = "#1F2937",
                TextSecondary = "#6B7280",
                ActionDefault = "#4A6EF1",
                ActionDisabled = "#D1D5DB",
                ActionDisabledBackground = "#E5E7EB",
                Divider = "#E5E7EB",
                LinesDefault = "#E5E7EB",
                TableLines = "#E5E7EB",
                Info = "#3B82F6",
                Success = "#10B981",
                Warning = "#F59E0B",
                Error = "#EF4444",
                GrayLight = "#E5E7EB",
                GrayLighter = "#F9FAFB",
            };
        }

        // Si no es modo claro, retornamos una paleta por defecto (no se usará)
        return new PaletteLight();
    }

    private PaletteDark GetDarkPalette()
    {
        if (_selectedTheme == "morena")
        {
            // Tema Morena (siempre en modo oscuro)
            return new PaletteDark()
            {
                Primary = "#CD853F", // Café claro
                Secondary = "#8B4513", // Café silla
                Tertiary = "#D2691E", // Chocolate

                Background = "#2D1B0F", // Café muy oscuro
                Surface = "#3D2A1C", // Café oscuro

                AppbarBackground = "#3D2A1CCC", // Café oscuro con transparencia
                AppbarText = "#F4E4C1", // Beige claro

                DrawerBackground = "#2D1B0F", // Café muy oscuro
                DrawerText = "#F4E4C1", // Beige claro
                DrawerIcon = "#CD853F", // Café claro

                TextPrimary = "#F4E4C1", // Beige claro
                TextSecondary = "#DEB887", // Madera

                ActionDefault = "#CD853F", // Café claro
                ActionDisabled = "#5D3A1A", // Café oscuro
                ActionDisabledBackground = "#3D2A1C", // Café oscuro

                Divider = "#5D3A1A", // Café oscuro
                LinesDefault = "#5D3A1A", // Café oscuro
                TableLines = "#5D3A1A", // Café oscuro

                Info = "#5F9EA0", // Azul cadete
                Success = "#6B8E23", // Verde oliva
                Warning = "#CD853F", // Café claro
                Error = "#B22222", // Rojo ladrillo

                GrayLight = "#5D3A1A", // Café oscuro
                GrayLighter = "#3D2A1C", // Café oscuro
                OverlayLight = "#2D1B0F80", // Café muy oscuro con transparencia
            };
        }
        else if (_selectedThemeOption == ThemeOption.Oscuro || _selectedThemeOption == ThemeOption.Morena)
        {
            // Tema Oscuro default
            return new PaletteDark()
            {
                Primary = "#4A6EF1",
                Secondary = "#F5A623",
                Tertiary = "#50C878",
                Background = "#111827",
                Surface = "#1F2937",
                AppbarBackground = "#1F2937CC",
                AppbarText = "#F9FAFB",
                DrawerBackground = "#1F2937",
                DrawerText = "#F9FAFB",
                DrawerIcon = "#4A6EF1",
                TextPrimary = "#F9FAFB",
                TextSecondary = "#9CA3AF",
                ActionDefault = "#4A6EF1",
                ActionDisabled = "#4B5563",
                ActionDisabledBackground = "#374151",
                Divider = "#374151",
                LinesDefault = "#374151",
                TableLines = "#374151",
                Info = "#60A5FA",
                Success = "#34D399",
                Warning = "#FBBF24",
                Error = "#F87171",
                GrayLight = "#374151",
                GrayLighter = "#1F2937",
                OverlayLight = "#1F293780",
            };
        }

        // Default (no debería llegar aquí)
        return new PaletteDark();
    }

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }
}