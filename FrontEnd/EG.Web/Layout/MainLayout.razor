@inherits LayoutComponentBase
@inject NavigationManager NavigationManager

<MudThemeProvider Theme="@_theme" IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@(_drawerOpen? Icons.Material.Filled.Menu : Icons.Material.Filled.ChevronRight)" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudText Typo="Typo.h5" Class="ml-3">GE.WebApp</MudText>
        <MudSpacer />
        <MudIconButton Icon="@(DarkLightModeButtonIcon)" Color="Color.Inherit" OnClick="@DarkModeToggle" />
        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopRight">
            <MudMenuItem OnClick="@Logout">Cerrar sesión</MudMenuItem>
        </MudMenu>
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen"
               ClipMode="DrawerClipMode.Always"
               Elevation="2">
        <DynamicMenu />
    </MudDrawer>
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large" >
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>

@code {
    private bool _drawerOpen = true;
    private bool _isDarkMode = true;
    private MudTheme? _theme = null;

    private async Task Logout()
    {
        // Ejecutar navegación en el hilo de UI (sin Task.Run)
        NavigationManager.NavigateTo("/login", forceLoad: true);
        await Task.CompletedTask;
    }

    private readonly Shadow _customShadows = new()
    {
        Elevation = new[]
        {
            "none", // 0
            "0px 1px 3px rgba(126,111,255,0.10)", // 1
            "0px 2px 8px rgba(126,111,255,0.10)", // 2
            "0px 4px 12px rgba(0, 0, 0, 0.08)", // Elevation 3
            "0px 6px 16px rgba(0, 0, 0, 0.10)", // Elevation 4
            "0px 8px 20px rgba(0, 0, 0, 0.12)", // Elevation 5
            "0px 10px 24px rgba(0, 0, 0, 0.14)", // Elevation 6
            "0px 12px 32px rgba(126,111,255,0.24)", // 7
            "0px 14px 36px rgba(126,111,255,0.26)", // 8
            "0px 16px 40px rgba(126,111,255,0.28)", // 9
            "0px 18px 44px rgba(126,111,255,0.30)", // 10
            "0px 20px 48px rgba(126,111,255,0.32)", // 11
            "0px 22px 52px rgba(126,111,255,0.34)", // 12
            "0px 24px 56px rgba(126,111,255,0.36)", // 13
            "0px 26px 60px rgba(126,111,255,0.38)", // 14
            "0px 28px 64px rgba(126,111,255,0.40)", // 15
            "0px 30px 68px rgba(126,111,255,0.42)", // 16
            "0px 32px 72px rgba(126,111,255,0.44)", // 17
            "0px 34px 76px rgba(126,111,255,0.46)", // 18
            "0px 36px 80px rgba(126,111,255,0.48)", // 19
            "0px 38px 84px rgba(126,111,255,0.50)", // 20
            "0px 40px 88px rgba(126,111,255,0.52)", // 21
            "0px 42px 92px rgba(126,111,255,0.54)", // 22
            "0px 44px 96px rgba(126,111,255,0.56)", // 23
            "0px 46px 100px rgba(126,111,255,0.58)" // 24
        }
    };

    protected override void OnInitialized()
    {
        base.OnInitialized();

        _theme = new()
        {
            PaletteLight = _lightPalette,
            PaletteDark = _darkPalette,
            LayoutProperties = new LayoutProperties()
            {
                DefaultBorderRadius = "10px"
            },
            Typography = new Typography()
            {
                Default = new DefaultTypography()
                {
                    FontFamily = new[] { "Segoe UI", "Roboto", "Arial", "sans-serif" },
                    FontSize = "1rem"
                },
                H5 = new H5Typography()
                {
                    FontWeight = "700",
                    FontSize = "1.4rem"
                }
            }
        };
    }

    private readonly PaletteLight _lightPalette = new()
    {
        Primary = "#4A6EF1",
        Secondary = "#F5A623",
        Tertiary = "#50C878",
        Background = "#F9FAFB",
        Surface = "#FFFFFF",
        AppbarBackground = "#FFFFFFCC",
        AppbarText = "#1F2937",
        DrawerBackground = "#F3F4F6",
        DrawerText = "#1F2937",
        DrawerIcon = "#4A6EF1",
        TextPrimary = "#1F2937",
        TextSecondary = "#6B7280",
        ActionDefault = "#4A6EF1",
        ActionDisabled = "#D1D5DB",
        ActionDisabledBackground = "#E5E7EB",
        Divider = "#E5E7EB",
        LinesDefault = "#E5E7EB",
        TableLines = "#E5E7EB",
        Info = "#3B82F6",
        Success = "#10B981",
        Warning = "#F59E0B",
        Error = "#EF4444",
        GrayLight = "#E5E7EB",
        GrayLighter = "#F9FAFB",
    };

    private readonly PaletteDark _darkPalette = new()
    {
        Primary = "#4A6EF1",
        Secondary = "#F5A623",
        Tertiary = "#50C878",
        Background = "#111827",
        Surface = "#1F2937",
        AppbarBackground = "#1F2937CC",
        AppbarText = "#F9FAFB",
        DrawerBackground = "#1F2937",
        DrawerText = "#F9FAFB",
        DrawerIcon = "#4A6EF1",
        TextPrimary = "#F9FAFB",
        TextSecondary = "#9CA3AF",
        ActionDefault = "#4A6EF1",
        ActionDisabled = "#4B5563",
        ActionDisabledBackground = "#374151",
        Divider = "#374151",
        LinesDefault = "#374151",
        TableLines = "#374151",
        Info = "#60A5FA",
        Success = "#34D399",
        Warning = "#FBBF24",
        Error = "#F87171",
        GrayLight = "#374151",
        GrayLighter = "#1F2937",
        OverlayLight = "#1F293780",
    };

    public string DarkLightModeButtonIcon => _isDarkMode switch
    {
        true => Icons.Material.Rounded.AutoMode,
        false => Icons.Material.Outlined.DarkMode,
    };

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void DarkModeToggle()
    {
        _isDarkMode = !_isDarkMode;
        // Forzar re-render para que el ThemeProvider aplique el cambio
        StateHasChanged();
    }

}