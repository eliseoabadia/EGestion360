@inherits LayoutComponentBase
@inject NavigationManager NavigationManager

<MudThemeProvider Theme="@_theme" IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1" Class="app-bar">
        <MudIconButton Icon="@(_drawerOpen? Icons.Material.Filled.MenuOpen : Icons.Material.Filled.Menu)"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="@((e) => DrawerToggle())" />
        <MudText Typo="Typo.h5" Class="ml-3 app-title">GE.WebApp</MudText>
        <MudSpacer />
        <MudIconButton Icon="@(DarkLightModeButtonIcon)" Color="Color.Inherit" OnClick="@DarkModeToggle" />
        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopRight">
            <MudMenuItem OnClick="@Logout">Cerrar sesión</MudMenuItem>
        </MudMenu>
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen"
               ClipMode="DrawerClipMode.Always"
               Elevation="2"
               Width="220px"
               Class="custom-drawer">
        <DynamicMenu />
    </MudDrawer>

    <MudMainContent Class="main-content">
        <div class="content-wrapper">
            @Body
        </div>
    </MudMainContent>
</MudLayout>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>

@code {
    private bool _drawerOpen = true;
    private bool _isDarkMode = true;
    private MudTheme? _theme = null;

    private async Task Logout()
    {
        NavigationManager.NavigateTo("/login", forceLoad: true);
        await Task.CompletedTask;
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        _theme = new()
        {
            PaletteLight = _lightPalette,
            PaletteDark = _darkPalette,
            LayoutProperties = new LayoutProperties()
            {
                DefaultBorderRadius = "10px"
            },
            Typography = new Typography()
            {
                Default = new DefaultTypography()
                {
                    FontFamily = new[] { "Segoe UI", "Roboto", "Arial", "sans-serif" },
                    FontSize = "0.95rem"
                },
                H5 = new H5Typography()
                {
                    FontWeight = "700",
                    FontSize = "1.4rem"
                },
                Overline = new OverlineTypography()
                {
                    FontSize = "0.8rem",
                    FontWeight = "500"
                },
                Subtitle2 = new Subtitle2Typography()
                {
                    FontSize = "0.875rem",
                    FontWeight = "500"
                }
            }
        };
    }

    private readonly PaletteLight _lightPalette = new()
    {
        Primary = "#4A6EF1",
        Secondary = "#F5A623",
        Tertiary = "#50C878",
        Background = "#F9FAFB",
        Surface = "#FFFFFF",
        AppbarBackground = "#FFFFFFCC",
        AppbarText = "#1F2937",
        DrawerBackground = "#F3F4F6",
        DrawerText = "#1F2937",
        DrawerIcon = "#4A6EF1",
        TextPrimary = "#1F2937",
        TextSecondary = "#6B7280",
        ActionDefault = "#4A6EF1",
        ActionDisabled = "#D1D5DB",
        ActionDisabledBackground = "#E5E7EB",
        Divider = "#E5E7EB",
        LinesDefault = "#E5E7EB",
        TableLines = "#E5E7EB",
        Info = "#3B82F6",
        Success = "#10B981",
        Warning = "#F59E0B",
        Error = "#EF4444",
        GrayLight = "#E5E7EB",
        GrayLighter = "#F9FAFB",
    };

    private readonly PaletteDark _darkPalette = new()
    {
        Primary = "#4A6EF1",
        Secondary = "#F5A623",
        Tertiary = "#50C878",
        Background = "#111827",
        Surface = "#1F2937",
        AppbarBackground = "#1F2937CC",
        AppbarText = "#F9FAFB",
        DrawerBackground = "#1F2937",
        DrawerText = "#F9FAFB",
        DrawerIcon = "#4A6EF1",
        TextPrimary = "#F9FAFB",
        TextSecondary = "#9CA3AF",
        ActionDefault = "#4A6EF1",
        ActionDisabled = "#4B5563",
        ActionDisabledBackground = "#374151",
        Divider = "#374151",
        LinesDefault = "#374151",
        TableLines = "#374151",
        Info = "#60A5FA",
        Success = "#34D399",
        Warning = "#FBBF24",
        Error = "#F87171",
        GrayLight = "#374151",
        GrayLighter = "#1F2937",
        OverlayLight = "#1F293780",
    };

    public string DarkLightModeButtonIcon => _isDarkMode switch
    {
        true => Icons.Material.Rounded.AutoMode,
        false => Icons.Material.Outlined.DarkMode,
    };

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void DarkModeToggle()
    {
        _isDarkMode = !_isDarkMode;
        StateHasChanged();
    }
}

<style>
    /* Estructura principal */
    .mud-layout {
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* App Bar fija */
    .app-bar {
        flex-shrink: 0;
    }

    /* Drawer con altura corregida */
    .custom-drawer {
        height: calc(100vh - 64px) !important; /* Resta la altura del AppBar */
        top: 64px !important;
        overflow-y: auto;
    }

    /* Estilos para el menú compacto */
    ::deep .mud-nav-link {
        font-size: 0.85rem !important;
        padding: 8px 12px !important;
        min-height: 40px !important;
    }

        ::deep .mud-nav-link .mud-nav-link-icon {
            font-size: 1.2rem !important;
            width: 24px !important;
            height: 24px !important;
        }

    ::deep .mud-nav-group .mud-nav-link {
        font-size: 0.8rem !important;
    }

    /* Contenido principal */
    .main-content {
        position: absolute !important;
        top: 64px !important; /* Altura del AppBar */
        left: 0;
        right: 0;
        bottom: 0;
        padding: 0 !important;
        overflow: hidden !important;
        transition: left 0.3s ease;
    }

    /* Ajuste de posición cuando el drawer está abierto */
    .mud-drawer--open ~ .main-content {
        left: 10px !important; /* Mismo ancho que el drawer */
    }

    /* Wrapper del contenido - Ocupa todo el espacio disponible */
    .content-wrapper {
        height: 100%;
        width: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        padding: 16px; /* Espaciado interno opcional */
        box-sizing: border-box;
    }

    /* Título de la app más compacto */
    .app-title {
        font-size: 1.2rem !important;
    }

    /* Para pantallas pequeñas */
    @@media (max-width: 600px) {
        .main-content {
            top: 56px !important; /* Altura del AppBar en móvil */
        }

        .custom-drawer {
            height: calc(100vh - 56px) !important;
            top: 56px !important;
        }

        .mud-drawer--open ~ .main-content {
            left: 220px !important;
        }

        .content-wrapper {
            padding: 8px;
        }
    }

    /* Para que la tabla ocupe todo el ancho disponible */
    ::deep .mud-table-container {
        overflow-x: auto;
        overflow-y: visible;
    }

    ::deep .mud-table {
        width: 100%;
    }

    /* Ajuste para el contenedor de la tabla */
    .table-container {
        height: calc(100% - 180px); /* Ajusta según el espacio que ocupen los filtros */
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    ::deep .mud-table {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    ::deep .mud-table-container {
        flex: 1;
        overflow: auto;
    }

    /* Campo de búsqueda más pequeño */
    .search-field {
        width: 250px;
    }

    /* Responsive */
    @@media (max-width: 600px) {
        .search-field {
            width: 100%;
            margin-top: 8px;
        }
    }
</style>