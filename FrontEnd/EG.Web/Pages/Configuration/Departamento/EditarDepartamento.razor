@using EG.Web.Contracs
@using EG.Web.Contracs.Configuration
@using EG.Web.Models.Configuration
@using EG.Web.Services
@using MudBlazor

@inject IGenericCrudService<DepartamentoResponse> _service
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IEmpresaService empresaService

<MudDialog MaxWidth="MaxWidth.Small" FullWidth="true">
    <DialogContent>
        @if (loading)
        {
            <div class="d-flex justify-center align-center py-6">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                <MudText Class="ml-3">Cargando departamento...</MudText>
            </div>
        }
        else
        {
            <MudForm @ref="form">
                <MudGrid GutterSize="2">
                    <!-- Nombre del departamento -->
                    <MudItem xs="12">
                        <MudTextField @bind-Value="departamento.DepartamentoNombre"
                                      Label="Nombre del Departamento"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="El nombre es requerido"
                                      ValidationPattern="@nombrePattern"
                                      ValidationError="El nombre debe tener al menos 3 caracteres"
                                      Class="mb-4" />
                    </MudItem>

                    <!-- Empresa (solo lectura si ya tiene valor) -->
                    <MudItem xs="12">
                        <MudSelect Label="Empresa"
                                   Variant="Variant.Outlined"
                                   T="int?"
                                   Immediate="true"
                                   Value="@departamento.PkidEmpresa"
                                   ValueChanged="@OnEmpresaChanged"
                                   RequiredError="Debe seleccionar una empresa"
                                   Class="mb-4"
                                   Dense="true">
                            <MudSelectItem T="int?" Value="@((int?)null)">Seleccione una empresa</MudSelectItem>
                            @foreach (var empresa in empresas)
                            {
                                <MudSelectItem T="int?" Value="@empresa.PkidEmpresa">@empresa.EmpresaNombre</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <!-- Estado -->
                    <MudItem xs="12">
                        <MudPaper Class="pa-3 mb-4" Elevation="1" Style="border-radius: 8px;">
                            <MudText Class="mb-2" Typo="Typo.body2" Color="Color.Default">Estado</MudText>
                            <MudRadioGroup @bind-Value="departamento.DepartamentoActivo" Class="mt-2">
                                <MudRadio T="bool?" Value="true" Color="Color.Success">Activo</MudRadio>
                                <MudRadio T="bool?" Value="false" Color="Color.Error">Inactivo</MudRadio>
                            </MudRadioGroup>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudForm>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel"
                   Variant="Variant.Text"
                   Color="Color.Secondary"
                   Disabled="@loading">
            Cancelar
        </MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="Guardar"
                   Disabled="@loading"
                   StartIcon="@Icons.Material.Filled.Save">
            @if (loading)
            {
                <MudProgressCircular Size="Size.Small" Color="Color.Default" Indeterminate="true" />
                <span class="ml-2">Guardando...</span>
            }
            else
            {
                <span>Guardar Cambios</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public int? DepartamentoId { get; set; }
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;

    private MudForm form = new MudForm();
    private DepartamentoResponse departamento = new DepartamentoResponse();
    private IList<EmpresaResponse> empresas = new List<EmpresaResponse>();
    private bool loading = true;
    private string nombrePattern = "^.{3,}$"; // Al menos 3 caracteres

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Cargar lista de empresas
            var responseEmpresas = await empresaService.GetAllEmpresasAsync();

            if (responseEmpresas == null || !responseEmpresas.Success || responseEmpresas.Items == null || !responseEmpresas.Items.Any())
            {
                Console.WriteLine("⚠️ No se cargaron empresas");
                Snackbar.Add(responseEmpresas?.Message ?? "Advertencia: No hay empresas disponibles", Severity.Warning);
                empresas = new List<EmpresaResponse>();
            }
            else
            {
                empresas = responseEmpresas.Items;
                Console.WriteLine($"✓ Se cargaron {empresas.Count} empresas");
                foreach (var e in empresas)
                {
                    Console.WriteLine($"  - ID: {e.PkidEmpresa}, Nombre: {e.EmpresaNombre}");
                }
            }

            // Si hay ID, cargar el departamento
            if (DepartamentoId.HasValue && DepartamentoId > 0)
            {
                var responseDepartamento = await _service.GetByIdAsync(DepartamentoId.Value);

                if (responseDepartamento == null || !responseDepartamento.Success || responseDepartamento.Data == null)
                {
                    Snackbar.Add(responseDepartamento?.Message ?? "Departamento no encontrado", Severity.Warning);
                    Cancel();
                    return;
                }

                departamento = responseDepartamento.Data;
            }
            else
            {
                Snackbar.Add("No se proporcionó un ID de departamento válido", Severity.Error);
                Cancel();
                return;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error: {ex.Message}\n{ex.StackTrace}");
            Snackbar.Add($"Error al cargar: {ex.Message}", Severity.Error);
            Cancel();
        }
        finally
        {
            loading = false;
        }
    }

    private string GetNombreEmpresa(int empresaId)
    {
        var empresa = empresas.FirstOrDefault(e => e.PkidEmpresa == empresaId);
        return empresa?.EmpresaNombre ?? "Empresa no encontrada";
    }

    private async Task Guardar()
    {
        try
        {
            loading = true;
            StateHasChanged();

            await form.Validate();

            if (!form.IsValid)
            {
                Snackbar.Add("Por favor, complete todos los campos requeridos correctamente", Severity.Warning);
                loading = false;
                return;
            }

            // Validaciones adicionales
            if (string.IsNullOrWhiteSpace(departamento.DepartamentoNombre) || departamento.DepartamentoNombre.Length < 3)
            {
                Snackbar.Add("El nombre del departamento debe tener al menos 3 caracteres", Severity.Warning);
                loading = false;
                return;
            }

            if (!departamento.PkidEmpresa.HasValue || departamento.PkidEmpresa.Value <= 0)
            {
                Snackbar.Add("Debe seleccionar una empresa válida", Severity.Warning);
                loading = false;
                return;
            }

            // Actualizar el departamento usando ApiResponse
            var response = await _service.UpdateAsync(departamento, departamento.PkidDepartamento.Value);

            if (response != null && response.Success)
            {
                // Construir mensaje detallado
                var message = !string.IsNullOrEmpty(response.Message)
                    ? response.Message
                    : $"✅ Departamento actualizado: ID {departamento.PkidDepartamento}, " +
                      $"Nombre: {departamento.DepartamentoNombre}, " +
                      $"Estado: {(departamento.DepartamentoActivo == true ? "Activo" : "Inactivo")}";

                // Escribir en consola y mostrar en Snackbar
                Console.WriteLine(message);
                Snackbar.Add(message, Severity.Success);

                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                var errorMessage = response?.Message ?? "Error al actualizar departamento";
                Console.WriteLine($"❌ {errorMessage}");
                Snackbar.Add(errorMessage, Severity.Error);
                loading = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error al guardar: {ex.Message}\n{ex.StackTrace}");
            Snackbar.Add($"Error al guardar: {ex.Message}", Severity.Error);
            loading = false;
        }
    }

    private async Task OnEmpresaChanged(int? empresaId)
    {
        Console.WriteLine($"Empresa seleccionada ID: {empresaId}");
        departamento.PkidEmpresa = empresaId;

        // Opcional: hacer algo cuando cambia la empresa
        // await LoadDepartamentosByEmpresa(empresaId);
    }

    private void Cancel() => MudDialog.Cancel();
}