@using System.ComponentModel.DataAnnotations
@using EG.Web.Contracs.Configuration
@using EG.Web.Models
@using EG.Web.Models.Configuration
@using EG.Web.Services
@using EG.Web.Services.Configuration
@using Microsoft.AspNetCore.Components.Forms
@using MudBlazor

@inject IJSRuntime _jsRuntime
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject EmpresaService empresaService
@inject IDepartamentoService departamentoService

<MudDialog MaxWidth="MaxWidth.Medium" FullWidth="true" CloseOnEscapeKey="false">
    <DialogContent>
        <!-- Indicador de carga -->
        <MudOverlay Visible="@loading" Fixed="true" ZIndex="10">
            <div class="d-flex flex-column align-center justify-center" style="height:100%">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                <MudText Class="mt-4">Cargando...</MudText>
            </div>
        </MudOverlay>
        <MudPaper Class="pa-6 my-6" Elevation="6">
            <MudGrid GutterSize="2">
                <!-- Información del departamento -->
                <MudForm @ref="form">
                    <MudCard Elevation="2" Class="pa-2">
                        <MudCardHeader>
                            <MudCardHeaderContent>
                                <MudText Typo="Typo.h5" Color="Color.Primary">
                                    @(isEditMode ? "Editar Departamento" : "Nuevo Departamento")
                                </MudText>
                            </MudCardHeaderContent>
                        </MudCardHeader>
                        <MudDivider Class="mb-4" />
                        <MudForm>
                            <MudGrid GutterSize="2">
                                <!-- Nombre del departamento -->
                                <MudItem xs="12" md="12">
                                    <MudTextField Label="Nombre del Departamento" 
                                                  @bind-Value="departamento.DepartamentoNombre" 
                                                  Required="true"
                                                  RequiredError="El nombre del departamento es requerido"
                                                  ValidationPattern="@nombrePattern"
                                                  ValidationError="El nombre debe tener al menos 3 caracteres" />
                                </MudItem>

                                <!-- Empresa -->
                                <MudItem xs="12">
                                    @if (isEditMode)
                                    {
                                        <!-- En modo edición: Solo lectura -->
                                        <MudSelect Label="Empresa"
                                                   Variant="Variant.Outlined"
                                                   T="int?"
                                                   Immediate="true"
                                                   For="@(() => departamento.PkidEmpresa)"
                                                   Value="@departamento.PkidEmpresa"
                                                   Disabled="true"
                                                   Required="true"
                                                   RequiredError="Debe seleccionar una empresa"
                                                   Class="mb-4"
                                                   Dense="true">
                                            @foreach (var empresa in empresas.Where(e => e.PkidEmpresa == departamento.PkidEmpresa))
                                            {
                                                <MudSelectItem T="int?" Value="@empresa.PkidEmpresa">@empresa.EmpresaNombre</MudSelectItem>
                                            }
                                        </MudSelect>
                                    }
                                    else
                                    {
                                        <!-- En modo creación: Seleccionable -->
                                        <MudSelect Label="Empresa"
                                                   Variant="Variant.Outlined"
                                                   T="int?"
                                                   Immediate="true"
                                                   For="@(() => departamento.PkidEmpresa)"
                                                   Value="@departamento.PkidEmpresa"
                                                   ValueChanged="@OnEmpresaChanged"
                                                   Required="true"
                                                   RequiredError="Debe seleccionar una empresa"
                                                   Class="mb-4"
                                                   Dense="true">
                                            <MudSelectItem T="int?" Value="@((int?)null)">Seleccione una empresa</MudSelectItem>
                                            @foreach (var empresa in empresas)
                                            {
                                                <MudSelectItem T="int?" Value="@empresa.PkidEmpresa">@empresa.EmpresaNombre</MudSelectItem>
                                            }
                                        </MudSelect>
                                    }
                                </MudItem>

                                <!-- Estado -->
                                <MudItem xs="12">
                                    <MudPaper Class="pa-3 mb-4" Elevation="1" Style="border-radius: 8px;">
                                        <MudText Class="mb-2" Typo="Typo.body2" Color="Color.Default">Estado</MudText>
                                        
                                        @if (isEditMode)
                                        {
                                            <!-- En modo edición: Switch para activar/desactivar -->
                                            <div class="d-flex align-center">
                                                <MudSwitch @bind-Value="departamento.DepartamentoActivo" 
                                                           Color="Color.Primary"
                                                           ThumbIcon="@(departamento.DepartamentoActivo == true ? Icons.Material.Filled.Check : Icons.Material.Filled.Close)">
                                                    <MudText>@(departamento.DepartamentoActivo == true ? "Activo" : "Inactivo")</MudText>
                                                </MudSwitch>
                                            </div>
                                        }
                                        else
                                        {
                                            <!-- En modo creación: Solo lectura y siempre Activo -->
                                            <div class="d-flex align-center">
                                                <MudChip T="string" Size="Size.Small" Color="Color.Success">Activo</MudChip>
                                                <MudText Typo="Typo.body2" Class="ml-2 text-secondary">
                                                    (Los nuevos departamentos se crean activos)
                                                </MudText>
                                            </div>
                                            <input type="hidden" @bind="departamento.DepartamentoActivo" />
                                        }
                                    </MudPaper>
                                </MudItem>
                            </MudGrid>

                            <!-- Botones -->
                            <div class="d-flex justify-end mt-6">
                                <MudButton Variant="Variant.Text" 
                                           Color="Color.Secondary" 
                                           Class="mr-2" 
                                           OnClick="Cancelar"
                                           Disabled="@loading">
                                    Cancelar
                                </MudButton> 
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Primary" 
                                           StartIcon="@Icons.Material.Filled.Save" 
                                           OnClick="GuardarCambiosAsync"
                                           Disabled="@loading">
                                    @if (loading)
                                    {
                                        <MudProgressCircular Size="Size.Small" Color="Color.Default" Indeterminate="true" />
                                        <span class="ml-2">Guardando...</span>
                                    }
                                    else
                                    {
                                        <span>@(isEditMode ? "Actualizar" : "Crear") Departamento</span>
                                    }
                                </MudButton>
                            </div>
                        </MudForm>
                    </MudCard>
                </MudForm>
            </MudGrid>
        </MudPaper>
    </DialogContent>
</MudDialog>

@code {
    [Parameter] public int? DepartamentoId { get; set; }
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;

    private MudForm form = new MudForm();
    private bool loading = false;
    private bool isEditMode => DepartamentoId.HasValue && DepartamentoId > 0;

    private IList<EmpresaResponse> empresas = new List<EmpresaResponse>();
    public DepartamentoResponse departamento { get; set; } = new DepartamentoResponse();

    private string nombrePattern = "^.{3,}$"; // Al menos 3 caracteres

    protected override async Task OnInitializedAsync()
    {
        loading = true;
        try
        {
            await LoadEmpresas();

            if (isEditMode)
            {
                await LoadDepartamentoData();
            }
            else
            {
                InitializeNewDepartamento();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar datos: {ex.Message}", Severity.Error);
            Cancelar();
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private void InitializeNewDepartamento()
    {
        departamento = new DepartamentoResponse
        {
            DepartamentoActivo = true, // Siempre activo en creación
            DepartamentoNombre = string.Empty,
            PkidEmpresa = null // Sin empresa seleccionada
        };

        Console.WriteLine("✅ Modo creación: Nuevo departamento inicializado (siempre activo)");
    }

    private async Task LoadEmpresas()
    {
        try
        {
            var response = await empresaService.GetAllEmpresasAsync();

            if (response != null && response.Success && response.Items != null && response.Items.Any())
            {
                empresas = response.Items;
                Console.WriteLine($"✓ Se cargaron {empresas.Count} empresas");
            }
            else
            {
                var errorMessage = response?.Message ?? "No se cargaron empresas";
                Console.WriteLine($"⚠️ {errorMessage}");
                Snackbar.Add(errorMessage, Severity.Warning);
                empresas = new List<EmpresaResponse>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error al cargar empresas: {ex.Message}\n{ex.StackTrace}");
            Snackbar.Add($"Error al cargar empresas: {ex.Message}", Severity.Error);
            empresas = new List<EmpresaResponse>();
        }
    }

    private async Task LoadDepartamentoData()
    {
        try
        {
            if (DepartamentoId.HasValue)
            {
                var response = await departamentoService.GetDepartamentoByIdAsync(DepartamentoId.Value);

                if (response != null && response.Success && response.Data != null)
                {
                    departamento = response.Data;
                    Console.WriteLine($"✅ Departamento cargado: ID {departamento.PkidDepartamento}, " +
                                      $"Nombre: {departamento.DepartamentoNombre}, " +
                                      $"Estado: {(departamento.DepartamentoActivo == true ? "Activo" : "Inactivo")}");
                }
                else
                {
                    var errorMessage = response?.Message ?? "Departamento no encontrado";
                    Console.WriteLine($"⚠️ {errorMessage}");
                    Snackbar.Add(errorMessage, Severity.Warning);
                    Cancelar();
                }
            }
            else
            {
                var errorMessage = "No se proporcionó un ID de departamento válido";
                Console.WriteLine($"❌ {errorMessage}");
                Snackbar.Add(errorMessage, Severity.Error);
                Cancelar();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error al cargar departamento: {ex.Message}\n{ex.StackTrace}");
            Snackbar.Add($"Error al cargar departamento: {ex.Message}", Severity.Error);
        }
    }

    private async Task GuardarCambiosAsync()
    {
        if (!await ValidarFormulario())
            return;

        loading = true;
        StateHasChanged();

        try
        {
            ApiResponse<DepartamentoResponse> response;

            if (isEditMode)
            {
                Console.WriteLine($"📝 Actualizando departamento ID: {departamento.PkidDepartamento}");
                response = await departamentoService.UpdateDepartamentoAsync(departamento);
            }
            else
            {
                departamento.DepartamentoActivo = true;
                departamento.Rfc = string.Empty;
                departamento.EmpresaActivo = true;
                departamento.PkidDepartamento = 0;

                Console.WriteLine($"➕ Creando nuevo departamento: {departamento.DepartamentoNombre} (Activo)");
                response = await departamentoService.CreateDepartamentoAsync(departamento);
            }

            if (response != null && response.Success)
            {
                var message = !string.IsNullOrEmpty(response.Message)
                    ? response.Message
                    : $"✅ Departamento {(isEditMode ? "actualizado" : "creado")}: ID {departamento.PkidDepartamento}, " +
                      $"Nombre: {departamento.DepartamentoNombre}, " +
                      $"Estado: {(departamento.DepartamentoActivo == true ? "Activo" : "Inactivo")}";

                Console.WriteLine(message);
                Snackbar.Add(message, Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                var errorMessage = response?.Message ?? "Error al guardar departamento";
                Console.WriteLine($"❌ {errorMessage}");
                Snackbar.Add(errorMessage, Severity.Error);
                loading = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error al guardar departamento: {ex.Message}\n{ex.StackTrace}");
            Snackbar.Add($"Error al guardar departamento: {ex.Message}", Severity.Error);
            loading = false;
            StateHasChanged();
        }
    }

    private async Task<bool> ValidarFormulario()
    {
        await form.Validate();

        if (!form.IsValid)
        {
            Snackbar.Add("Por favor, completa todos los campos requeridos correctamente.", Severity.Warning);
            return false;
        }

        // Validar que se haya seleccionado una empresa
        if (!departamento.PkidEmpresa.HasValue || departamento.PkidEmpresa.Value <= 0)
        {
            Snackbar.Add("Debe seleccionar una empresa válida", Severity.Warning);
            return false;
        }

        // Validar nombre del departamento
        if (string.IsNullOrWhiteSpace(departamento.DepartamentoNombre) || 
            departamento.DepartamentoNombre.Length < 3)
        {
            Snackbar.Add("El nombre del departamento debe tener al menos 3 caracteres", Severity.Warning);
            return false;
        }

        return true;
    }

    private async Task OnEmpresaChanged(int? empresaId)
    {
        Console.WriteLine($"Empresa seleccionada ID: {empresaId}");
        departamento.PkidEmpresa = empresaId;
        await Task.CompletedTask;
    }

    private void Cancelar() => MudDialog.Cancel();
}