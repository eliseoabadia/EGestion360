@page "/departamentos"
@using System.ComponentModel.DataAnnotations
@using EG.Web.Contracs.Configuration
@using EG.Web.Models.Configuration
@using EG.Web.Services
@using Microsoft.AspNetCore.Components.Forms
@using System.Text
@using MiniExcelLibs
@using MudBlazor
@using System.Reflection

@inject NavigationManager NavigationManager
@inject IDepartamentoService departamentoService
@inject ISnackbar Snackbar
@inject AuthService AuthService
@inject IJSRuntime _jsRuntime
@inject IEmpresaService empresaService

<script>
    function downloadFile(base64Data, fileName, contentType) {
        try {
            const link = document.createElement('a');
            link.href = 'data:' + contentType + ';base64,' + base64Data;
            link.download = fileName;
            link.style.display = 'none';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error('Error downloading file:', error);
            throw error;
        }
    }
</script>

<MudContainer Class="px-2 d-flex flex-column" MaxWidth="MaxWidth.False" Style="height: 100vh;">

    <!-- Usando Card para el header -->
    <MudCard Elevation="1" Class="mb-4">
        <MudCardContent>
            <MudGrid Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudItem>
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h4"
                                 Color="Color.Primary"
                                 Style="font-weight: 600; display: flex; align-items: center; gap: 12px;">
                            <MudIcon Icon="@Icons.Material.Filled.Business"
                                     Color="Color.Primary"
                                     Size="Size.Large" />
                            Gestión de Departamentos
                        </MudText>
                        <MudText Typo="Typo.body2"
                                 Color="Color.Tertiary"
                                 Class="ml-6">
                            Administra y mantén el registro de departamentos del sistema
                        </MudText>
                    </MudStack>
                </MudItem>

                <MudItem>
                    <MudButtonGroup Variant="Variant.Filled" Color="Color.Primary">
                        <MudTooltip Text="Nuevo Departamento">
                            <MudButton StartIcon="@Icons.Material.Filled.Add"
                                       OnClick="CrearDepartamento"
                                       Size="Size.Small" />
                        </MudTooltip>
                        <MudTooltip Text="Refrescar...">
                            <MudButton StartIcon="@Icons.Material.Filled.Refresh"
                                       OnClick="OnSearchInput"
                                       Size="Size.Small" />
                        </MudTooltip>
                    </MudButtonGroup>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <MudPaper Elevation="2" Class="pa-4 rounded-lg">
        <!-- Agregar filtro por empresa -->
        <MudGrid Spacing="2" Class="mb-4">
            <MudItem xs="12" sm="6" md="4">
                <MudSelect T="int?"
                           Value="selectedEmpresaId"
                           Variant="Variant.Outlined">
                    <MudSelectItem T="int?" Value="@null">Todas las empresas</MudSelectItem>
                    @foreach (var e in listadoEmpresas)
                    {
                        <MudSelectItem Value="@e.PkidEmpresa">@e.EmpresaNombre</MudSelectItem>
                    }
                </MudSelect> 
                
            </MudItem>
        </MudGrid>

        <MudTable ServerData="LoadServerData"
                  RowsPerPage="@pageSize"
                  Page="@currentPage"
                  RowCount="@totalCount"
                  @ref="mudTableRef"
                  Dense="@dense"
                  Hover="@hover"
                  Loading="@loading"
                  ReadOnly="@ronly"
                  SortLabel="Sort By"
                  InitialSortDirection="SortDirection.Descending"
                  @bind-SelectedItem="selectedItem1"
                  IsEditRowSwitchingBlocked="@blockSwitch"
                  ApplyButtonPosition="@applyButtonPosition"
                  EditButtonPosition="@editButtonPosition"
                  EditTrigger="@editTrigger">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Lista de Departamentos</MudText>
                <MudSpacer />
                <!-- Botón de Exportar a Excel -->
                <MudTooltip Text="Exportar a Excel">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Success"
                               StartIcon="@Icons.Material.Filled.FileDownload"
                               OnClick="ExportarExcel"
                               Size="Size.Small"
                               Class="mr-2"
                               Disabled="@loading">
                        @if (loading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Exportando...</span>
                        }
                        else
                        {
                            <span>Exportar Excel</span>
                        }
                    </MudButton>
                </MudTooltip>
                <MudTextField @bind-Value="searchString"
                              Placeholder="Buscar por nombre..."
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              IconSize="Size.Medium"
                              Immediate="true"
                              @ref="txtSerch"
                              OnKeyUp="HandleKeyUp"
                              Class="mt-0">
                </MudTextField>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Acciones</MudTh>
                <MudTh><MudTableSortLabel InitialDirection="SortDirection.Descending" SortLabel="PkidDepartamento" T="DepartamentoResponse">ID</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="DepartamentoNombre" T="DepartamentoResponse">Nombre</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="EmpresaNombre" T="DepartamentoResponse">Empresa</MudTableSortLabel></MudTh>
                <MudTh>Estado</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <MudTooltip Text="Editar departamento">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       OnClick="@(() => EditarDepartamento(context.PkidDepartamento))" />
                    </MudTooltip>

                    <MudTooltip Text="Eliminar departamento">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="@(() => EliminarDepartamento(context.PkidDepartamento))" />
                    </MudTooltip>
                </MudTd>

                <MudTd DataLabel="ID">@context.PkidDepartamento</MudTd>
                <MudTd DataLabel="Nombre">@context.DepartamentoNombre</MudTd>
                <MudTd DataLabel="Empresa">@context.EmpresaNombre</MudTd>
                <MudTd DataLabel="Estado">
                    <MudBadge Color="@(context.DepartamentoActivo == true? Color.Success: Color.Error)"
                              Variant="Variant.Filled"
                              Size="Size.Small">
                        @(context.DepartamentoActivo == true ? "Activo" : "Inactivo")
                    </MudBadge>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No se encontraron registros</MudText>
            </NoRecordsContent>
            <LoadingContent>
                <MudText>Cargando...</MudText>
            </LoadingContent>
            <PagerContent>
                <MudTablePager RowsPerPageString="Filas por página"
                               FirstPageIcon="@Icons.Material.Filled.FirstPage"
                               LastPageIcon="@Icons.Material.Filled.LastPage"
                               NextPageIcon="@Icons.Material.Filled.NavigateNext"
                               PreviousPageIcon="@Icons.Material.Filled.NavigateBefore"
                               PageSizeOptions="new int[] { 5, 10, 20, 50 }"
                               ShowFirstLastPage="true"
                               ShowPageSizeSelector="true"
                               ShowPaginationText="true"
                               PaginationTextFormat="Página {0} de {1}" />
            </PagerContent>

        </MudTable>
    </MudPaper>

</MudContainer>

@code {
    private IList<DepartamentoResponse> Elements = new List<DepartamentoResponse>();
    private IList<EmpresaResponse> listadoEmpresas = new List<EmpresaResponse>();
    private CancellationTokenSource _cancellationTokenSource = new();
    private int totalCount = 0;

    [Inject] private IDialogService DialogService { get; set; } = null!;

    private bool _isInitialized = false;

    private bool dense = true;
    private bool hover = true;
    private bool ronly = true;
    private bool blockSwitch = false;

    private DepartamentoResponse selectedItem1 = new DepartamentoResponse();
    private MudTable<DepartamentoResponse> mudTableRef = new MudTable<DepartamentoResponse>();

    private MudTextField<string> txtSerch = new MudTextField<string>();

    private string searchString = string.Empty;
    private int? selectedEmpresaId;

    private EstadoFiltro? selectedEstado = null; // Filtro por estado (ahora usando el enum)
    private bool loading = true;
    private int currentPage = 0;
    private int pageSize = 10;
    private int[] pageSizeOptions = new[] { 10, 25, 50, 100 };
    private CancellationTokenSource searchCts = new CancellationTokenSource();

    private HashSet<DepartamentoResponse> selectedItems1 = new HashSet<DepartamentoResponse>();
    private TableApplyButtonPosition applyButtonPosition = TableApplyButtonPosition.End;
    private TableEditButtonPosition editButtonPosition = TableEditButtonPosition.End;
    private TableEditTrigger editTrigger = TableEditTrigger.RowClick;

    private SortDirection sortDirection;
    private string sortLabel = string.Empty;



    // Definir el enum
    public enum EstadoFiltro
    {
        [Display(Name = "Todos los estados")]
        Todos,

        [Display(Name = "Activo")]
        Activo,

        [Display(Name = "Inactivo")]
        Inactivo
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await CargarEmpresas();
            //await CargarDepartamentos();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar empresas: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isInitialized = true;
            loading = false;
        }
    }

    private async Task CargarEmpresas()
    {
        try
        {
            var _result = await empresaService.GetAllEmpresasAsync();
            if (_result != null)
            {
                if (_result.Success)
                {

                    listadoEmpresas = _result.Items;

                    // Si solo hay una empresa, seleccionarla automáticamente
                    if (listadoEmpresas.Count == 1)
                    {
                        selectedEmpresaId = listadoEmpresas.First().PkidEmpresa;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar empresas: {ex.Message}", Severity.Error);
            listadoEmpresas = new List<EmpresaResponse>();
        }
        finally
        {
            StateHasChanged();
        }
    }

    
    private async Task<TableData<DepartamentoResponse>> LoadServerData(TableState state, CancellationToken cancellationToken)
    {
        loading = true;
        StateHasChanged();

        try
        {
            currentPage = state.Page + 1;
            pageSize = state.PageSize;
            sortLabel = state.SortLabel ?? "Nombre";
            sortDirection = state.SortDirection;

            string estadoFiltro = selectedEstado switch
            {
                EstadoFiltro.Activo => "true",
                EstadoFiltro.Inactivo => "false",
                EstadoFiltro.Todos or null => null,
                _ => null
            };

            var response = await departamentoService.GetAllDepartamentosPaginadoAsync(
                currentPage,
                pageSize,
                searchString,
                sortLabel,
                sortDirection,
                selectedEmpresaId,
                estadoFiltro
            );

            if (response != null && response.Success)
            {
                Elements = response.Items;
                totalCount = response.TotalCount;
            }
            else
            {
                Elements = new List<DepartamentoResponse>();
                totalCount = 0;
                Snackbar.Add(response?.Message ?? "Error al cargar departamentos", Severity.Error);
            }

            return new TableData<DepartamentoResponse>
            {
                Items = Elements,
                TotalItems = totalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar departamentos: {ex.Message}", Severity.Error);
            return new TableData<DepartamentoResponse>
            {
                Items = new List<DepartamentoResponse>(),
                TotalItems = 0
            };
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async void OnSearchInput()
    {
        searchCts?.Cancel();
        searchCts = new CancellationTokenSource();

        try
        {
            await Task.Delay(500, searchCts.Token);

            if (!searchCts.Token.IsCancellationRequested && mudTableRef != null)
            {
                currentPage = 0; // Reiniciar a la primera página
                await mudTableRef.ReloadServerData();
            }
        }
        catch (TaskCanceledException)
        {
            Console.WriteLine("Búsqueda cancelada");
        }
    }

    private async Task OnEmpresaChanged(int? empresaId)
    {
        selectedEmpresaId = empresaId;

        // Aquí llamas tu método de carga o filtrado
        currentPage = 0; // Reiniciar a la primera página
        if (mudTableRef != null)
            await mudTableRef.ReloadServerData();

        StateHasChanged();
    }

    private async Task LimpiarFiltros()
    {
        searchString = string.Empty;
        selectedEmpresaId = null;
        selectedEstado = null; // Limpiar el enum

        currentPage = 0;
        if (mudTableRef != null)
        {
            await mudTableRef.ReloadServerData();
        }
    }

    private async void HandleKeyUp(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            currentPage = 0;
            await mudTableRef.ReloadServerData();
        }
    }

    private async Task CrearDepartamento()
    {
        try
        {
            var parameters = new DialogParameters();
            var options = new DialogOptions
            {
                CloseButton = true,
                MaxWidth = MaxWidth.Medium,
                FullWidth = false,
                Position = DialogPosition.Center,
                NoHeader = false,
            };

            var dialog = await DialogService.ShowAsync<CrearDepartamento>("Crear Departamento", parameters, options);
            var result = await dialog.Result;

            if (!result!.Canceled)
            {
                currentPage = 0;
                await mudTableRef.ReloadServerData();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Ocurrió un error: " + ex.Message, Severity.Error);
        }
    }

    private async Task EditarDepartamento(int? id)
    {
        if (!id.HasValue) return;

        try
        {
            var parameters = new DialogParameters { ["DepartamentoId"] = id.Value };
            var options = new DialogOptions
            {
                CloseButton = true,
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
            };

            var dialog = await DialogService.ShowAsync<EditarDepartamento>("Editar Departamento", parameters, options);
            var result = await dialog.Result;

            if (!result!.Canceled)
            {
                await mudTableRef.ReloadServerData();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error al editar departamento: " + ex.Message, Severity.Error);
        }
    }

    private async Task EliminarDepartamento(int? id)
    {
        if (!id.HasValue) return;

        try
        {
            var parameters = new DialogParameters { ["DepartamentoId"] = id.Value };
            var options = new DialogOptions
            {
                CloseButton = true,
                MaxWidth = MaxWidth.Small,
                FullWidth = true,
            };

            var dialog = await DialogService.ShowAsync<EliminarDepartamento>("Eliminar Departamento", parameters, options);
            var result = await dialog.Result;

            if (!result!.Canceled)
            {
                if (Elements.Count == 1 && currentPage > 0)
                {
                    currentPage--;
                }
                await mudTableRef.ReloadServerData();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error al eliminar departamento: " + ex.Message, Severity.Error);
        }
    }

    private async Task ExportarExcel()
    {
        try
        {
            loading = true;
            StateHasChanged();

            var _currentPage = -1;

            // Convertir el enum a string para la exportación
            string estadoFiltro = selectedEstado switch
            {
                EstadoFiltro.Activo => "true",
                EstadoFiltro.Inactivo => "false",
                EstadoFiltro.Todos or null => null,
                _ => null
            };

            var response = await departamentoService.GetAllDepartamentosPaginadoAsync(
                _currentPage,
                pageSize,
                searchString,
                sortLabel,
                sortDirection,
                selectedEmpresaId,
                estadoFiltro
            );

            if (response == null || !response.Success || response.Items == null || !response.Items.Any())
            {
                Snackbar.Add(response?.Message ?? "No hay datos para exportar", Severity.Warning);
                loading = false;
                StateHasChanged();
                return;
            }

            Elements = response.Items;
            totalCount = response.TotalCount;

            var excelData = Elements.Select(d => new
            {
                ID = d.PkidDepartamento,
                Nombre = d.DepartamentoNombre,
                Empresa = d.EmpresaNombre,
                Estado = (d.DepartamentoActivo == true) ? "Activo" : "Inactivo"
            }).ToList();

            using var memoryStream = new MemoryStream();
            await memoryStream.SaveAsAsync(excelData);

            var fileBytes = memoryStream.ToArray();
            var base64 = Convert.ToBase64String(fileBytes);

            await _jsRuntime.InvokeVoidAsync("downloadFile", base64,
                $"Departamentos_{DateTime.Now:yyyyMMddHHmmss}.xlsx",
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

            Snackbar.Add($"Exportación exitosa: {Elements.Count} registros", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al exportar: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private static string GetDisplayName(Enum value)
    {
        var field = value.GetType().GetField(value.ToString());
        if (field == null) return value.ToString();

        var attribute = field.GetCustomAttribute<DisplayAttribute>();
        return attribute?.Name ?? value.ToString();
    }

    public void Dispose()
    {
        _cancellationTokenSource?.Cancel();
        _cancellationTokenSource?.Dispose();
        GC.SuppressFinalize(this);
    }
}

