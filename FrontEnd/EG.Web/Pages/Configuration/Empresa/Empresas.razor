@page "/configuracion/empresas"
@using EG.Web.Models.Configuration
@using EG.Web.Pages.Shared
@using EG.Web.Shared
@inherits BaseCrudPage<EmpresaResponse, EmpresaResponse>

<AccessVerification IsInitialized="@IsInitialized"
                    HasAccess="@HasAccess"
                    NavigateToHome="NavigateToHome">
    <MudContainer Class="px-2 d-flex flex-column" MaxWidth="MaxWidth.False" Style="height: 100vh;">
        <PageHeader Title="Gestión de Empresas"
                    Subtitle="Administra y mantén el registro de empresas del sistema"
                    Icon="@Icons.Material.Filled.Business"
                    CanCreate="@CanCreate"
                    OnCreate="CreateItem"
                    OnRefresh="() => table.ReloadData()" />

        <GenericTable TItem="EmpresaResponse"
                      @ref="table"
                      Title="Lista de Empresas"
                      SearchPlaceholder="Buscar por nombre o RFC..."
                      ShowExportButton="@CanExport"
                      ServerDataFunc="LoadServerData"
                      ExportFunc="ExportToExcel"
                      SearchString="@SearchString"
                      SearchStringChanged="(s) => SearchString = s"
                      OnSearch="OnSearch">

            <Header>
                <MudTh>Acciones</MudTh>
                <MudTh><MudTableSortLabel SortLabel="PkidEmpresa" T="EmpresaResponse">ID</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="EmpresaNombre" T="EmpresaResponse">Nombre</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="EstadoNombre" T="EmpresaResponse">Entidad</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="Rfc" T="EmpresaResponse">RFC</MudTableSortLabel></MudTh>
                <MudTh>Estado</MudTh>
            </Header>

            <Row Context="empresa">
                <MudTd>
                    <MudTooltip Text="Editar empresa">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Visible="@CanUpdate"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       OnClick="@(() => EditItem(empresa.PkidEmpresa!.Value))" />
                    </MudTooltip>
                    <MudTooltip Text="Eliminar empresa">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Visible="@CanDelete"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="@(() => DeleteItem(empresa.PkidEmpresa!.Value))" />
                    </MudTooltip>
                </MudTd>
                <MudTd>@empresa.PkidEmpresa</MudTd>
                <MudTd>@empresa.EmpresaNombre</MudTd>
                <MudTd>@empresa.EstadoNombre</MudTd>
                <MudTd>@empresa.Rfc</MudTd>
                <MudTd>
                    <MudBadge Color="@(empresa.EmpresaActivo == true ? Color.Success : Color.Error)"
                              Variant="Variant.Filled"
                              Size="Size.Small">
                        @(empresa.EmpresaActivo == true ? "Activo" : "Inactivo")
                    </MudBadge>
                </MudTd>
            </Row>
        </GenericTable>
    </MudContainer>
</AccessVerification>

@code {
    private GenericTable<EmpresaResponse> table = null!;

    protected override string ModuleName => "configuracion";
    protected override string SubModuleName => "empresas";

    protected override Type CreateDialogType => typeof(EmpresaDialog);
    protected override Type EditDialogType => typeof(EmpresaDialog);
    protected override Type DeleteDialogType => typeof(DeleteDialog<EmpresaResponse>);

    protected override string GetDefaultSortLabel() => "EmpresaNombre";

    protected override IEnumerable<object> MapToExcelData(IEnumerable<EmpresaResponse> items)
    {
        return items.Select(e => new
        {
            ID = e.PkidEmpresa,
            Nombre = e.EmpresaNombre,
            RFC = e.Rfc,
            Estado = e.EmpresaActivo == true ? "Activo" : "Inactivo"
        });
    }

    // SOBRESCRIBIR métodos para recargar la tabla
    protected override async Task CreateItem()
    {
        await base.CreateItem();
        await table.ReloadData();  // Recargar después de crear
    }

    protected override async Task EditItem(int id)
    {
        await base.EditItem(id);
        await table.ReloadData();  // Recargar después de editar
    }

    protected override async Task DeleteItem(int id)
    {
        await base.DeleteItem(id);
        await table.ReloadData();  // Recargar después de eliminar
    }
}