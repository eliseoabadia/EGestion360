@using MudBlazor
@using EG.Web.Contracs
@using EG.Web.Contracs.Configuration
@using EG.Web.Services.Configuration
@inject ISucursalService sucursalService
@inject IGenericCrudService<UsuarioResponse> _service
@inject ISnackbar Snackbar

<BaseCrudDialog TItem="UsuarioResponse"
                @ref="dialog"
                MaxWidth="MaxWidth.Medium"
                ActionText="@actionText"
                ProcessingText="@processingText"
                LoadingMessage="Cargando datos del usuario..."
                OnConfirm="GuardarCambiosAsync">

    <BaseEntityForm TEntity="UsuarioResponse"
                    @ref="form"
                    ShowHeader="true"
                    HeaderTitle="@dialogTitle">

        <MudGrid GutterSize="2">
            <!-- Datos personales -->
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="usuario.NombreCompleto"
                              Label="Nombre completo"
                              Variant="Variant.Outlined"
                              Required="true"
                              RequiredError="El nombre completo es requerido"
                              Validation="@(new Func<string, IEnumerable<string>>(ValidarNombreCompleto))"
                              For="@(() => usuario.NombreCompleto)" />
            </MudItem>

            <!-- Sucursal -->
            <MudItem xs="12" md="6">
                <MudSelect Label="Sucursal"
                           @bind-Value="usuario.IdEmpresa"
                           T="int"
                           Variant="Variant.Outlined"
                           Required="true"
                           RequiredError="Debe seleccionar una sucursal"
                           For="@(() => usuario.IdEmpresa)">
                    <MudSelectItem T="int" Value="0">Seleccione una sucursal</MudSelectItem>
                    @foreach (var sucursal in listadoSucursales)
                    {
                        <MudSelectItem T="int" Value="@sucursal.PkidSucursal">@sucursal.Nombre</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <!-- Contacto -->
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="usuario.Email"
                              Label="Email"
                              Variant="Variant.Outlined"
                              InputType="InputType.Email"
                              Required="true"
                              RequiredError="El email es requerido"
                              Validation="@(new Func<string, IEnumerable<string>>(ValidarEmail))"
                              For="@(() => usuario.Email)" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="usuario.TelefonoPrincipal"
                              Label="Teléfono"
                              Variant="Variant.Outlined"
                              Mask="@(new PatternMask("(##) ####-####"))"
                              Placeholder="(99) 9999-9999" />
            </MudItem>

            <!-- Dirección -->
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="usuario.Direccion1"
                              Label="Dirección 1"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="usuario.Direccion2"
                              Label="Dirección 2"
                              Variant="Variant.Outlined" />
            </MudItem>

            <!-- Código Postal -->
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="usuario.CodigoPostalUsuario"
                              Label="Código Postal"
                              Variant="Variant.Outlined"
                              Mask="@(new PatternMask("#####"))"
                              Placeholder="12345" />
            </MudItem>

            <!-- Campos adicionales -->
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="usuario.PayrollId"
                              Label="Payroll ID"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="usuario.NumeroSocial"
                              Label="Número Social"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="usuario.Gafete"
                              Label="Gafete"
                              Variant="Variant.Outlined" />
            </MudItem>

            <!-- Estado del Usuario -->
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="1" Style="border-radius: 8px;">
                    <MudText Class="mb-2" Typo="Typo.subtitle2">Estado del Usuario</MudText>
                    <MudDivider Class="mb-3" />
                    <MudRadioGroup @bind-Value="usuario.UsuarioActivo" Dense="true">
                        <MudRadio Value="true" Color="Color.Success">Activo</MudRadio>
                        <MudRadio Value="false" Color="Color.Error">Inactivo</MudRadio>
                    </MudRadioGroup>
                </MudPaper>
            </MudItem>

            <!-- Género -->
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="1" Style="border-radius: 8px;">
                    <MudText Class="mb-2" Typo="Typo.subtitle2">Género</MudText>
                    <MudDivider Class="mb-3" />
                    <MudRadioGroup @bind-Value="usuario.Sexo" Dense="true">
                        <MudRadio Value="true" Color="Color.Primary">Femenino</MudRadio>
                        <MudRadio Value="false" Color="Color.Primary">Masculino</MudRadio>
                    </MudRadioGroup>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </BaseEntityForm>
</BaseCrudDialog>

@code {
    [Parameter] public int? Id { get; set; }  // CORREGIDO: Ahora usa Id en lugar de UsuarioId

    private BaseCrudDialog<UsuarioResponse> dialog = null!;
    private BaseEntityForm<UsuarioResponse> form = null!;
    private UsuarioResponse usuario = new() { UsuarioActivo = true };
    private IList<SucursalResponse> listadoSucursales = new List<SucursalResponse>();

    private string dialogTitle => Id.HasValue ? "Editar Usuario" : "Nuevo Usuario";
    private string actionText => Id.HasValue ? "Actualizar" : "Crear";
    private string processingText => Id.HasValue ? "Actualizando..." : "Creando...";

    protected override async Task OnInitializedAsync()
    {
        await CargarSucursales();

        if (Id.HasValue)  // CORREGIDO
        {
            await CargarUsuario();
        }
    }

    private async Task CargarSucursales()
    {
        try
        {
            var response = await sucursalService.GetAllSucursales();
            if (response?.Success == true && response.Items != null)
            {
                listadoSucursales = response.Items.ToList();
                Console.WriteLine($"✅ Cargadas {listadoSucursales.Count} sucursales");
            }
            else
            {
                Console.WriteLine("⚠️ No se pudieron cargar las sucursales");
                Snackbar.Add(response?.Message ?? "Error al cargar sucursales", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error cargando sucursales: {ex.Message}");
            Snackbar.Add($"Error al cargar sucursales: {ex.Message}", Severity.Error);
        }
    }

    private async Task CargarUsuario()
    {
        try
        {
            var response = await _service.GetByIdAsync(Id!.Value);  // CORREGIDO
            if (response?.Success == true && response.Data != null)
            {
                usuario = response.Data;
                Console.WriteLine($"✅ Usuario cargado: {usuario.NombreCompleto}");
            }
            else
            {
                Console.WriteLine("⚠️ No se pudo cargar el usuario");
                Snackbar.Add(response?.Message ?? "Error al cargar usuario", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error cargando usuario: {ex.Message}");
            Snackbar.Add($"Error al cargar usuario: {ex.Message}", Severity.Error);
        }
    }

    private IEnumerable<string> ValidarNombreCompleto(string nombre)
    {
        if (string.IsNullOrWhiteSpace(nombre))
        {
            yield return "El nombre completo es requerido";
            yield break;
        }

        nombre = nombre.Trim();

        if (nombre.Length < 3)
            yield return "El nombre debe tener al menos 3 caracteres";

        if (nombre.Length > 100)
            yield return "El nombre no puede exceder los 100 caracteres";
    }

    private IEnumerable<string> ValidarEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
        {
            yield return "El email es requerido";
            yield break;
        }

        email = email.Trim();

        if (!email.Contains("@") || !email.Contains("."))
        {
            yield return "El email no tiene un formato válido";
        }

        // Validación más estricta con regex
        if (!System.Text.RegularExpressions.Regex.IsMatch(email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
        {
            yield return "El formato del email no es válido";
        }
    }

    private string GenerarIniciales()
    {
        if (string.IsNullOrWhiteSpace(usuario.NombreCompleto))
            return string.Empty;

        var palabras = usuario.NombreCompleto.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (palabras.Length == 0)
            return string.Empty;

        // Tomar primera letra de cada palabra (máximo 3 caracteres)
        var iniciales = string.Concat(palabras.Select(p => char.ToUpper(p[0])));
        return iniciales.Length > 3 ? iniciales.Substring(0, 3) : iniciales;
    }

    private async Task GuardarCambiosAsync()
    {
        // Validar el formulario
        if (!await form.ValidateAsync())
        {
            Snackbar.Add("Por favor, completa todos los campos requeridos correctamente.", Severity.Warning);
            return;
        }

        // Validar selección de sucursal
        if (usuario.IdEmpresa <= 0)
        {
            Snackbar.Add("Debe seleccionar una sucursal", Severity.Warning);
            return;
        }

        try
        {
            // Generar iniciales automáticamente
            usuario.Iniciales = GenerarIniciales();

            ApiResponse<UsuarioResponse> response;

            if (Id.HasValue)  // CORREGIDO
            {
                Console.WriteLine($"📝 Actualizando usuario ID: {usuario.PkIdUsuario}");
                response = await _service.UpdateAsync(usuario, usuario.PkIdUsuario);
            }
            else
            {
                Console.WriteLine($"➕ Creando nuevo usuario: {usuario.NombreCompleto}");
                response = await _service.CreateAsync(usuario);
            }

            if (response?.Success == true)
            {
                var message = response.Message ??
                    $"✅ Usuario {(Id.HasValue ? "actualizado" : "creado")} exitosamente";

                Snackbar.Add(message, Severity.Success);
                dialog.Close(true);
            }
            else
            {
                var errorMessage = response?.Message ?? "Error en la operación";
                Console.WriteLine($"❌ {errorMessage}");
                Snackbar.Add(errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error: {ex.Message}");
            Snackbar.Add($"Error al guardar: {ex.Message}", Severity.Error);
        }
    }
}