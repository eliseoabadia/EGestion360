@page "/configuracion/usuarios"
@using EG.Web.Models.Configuration
@using EG.Web.Pages.Shared
@using EG.Web.Shared
@inherits BaseCrudPage<UsuarioResponse, UsuarioResponse>

<AccessVerification IsInitialized="@IsInitialized"
                    HasAccess="@HasAccess"
                    NavigateToHome="NavigateToHome">
    <MudContainer Class="px-2 d-flex flex-column" MaxWidth="MaxWidth.False" Style="height: 100vh;">
        <PageHeader Title="Gestión de Usuarios"
                    Subtitle="Administra y mantén el registro de usuarios del sistema"
                    Icon="@Icons.Material.Filled.PeopleAlt"
                    CanCreate="@CanCreate"
                    OnCreate="CreateItem"
                    OnRefresh="() => table.ReloadData()" />

        <GenericTable TItem="UsuarioResponse"
                      @ref="table"
                      Title="Lista de Usuarios"
                      SearchPlaceholder="Buscar por nombre, email o teléfono..."
                      ShowExportButton="@CanExport"
                      ServerDataFunc="LoadServerData"
                      ExportFunc="ExportToExcel"
                      SearchString="@SearchString"
                      SearchStringChanged="(s) => SearchString = s"
                      OnSearch="OnSearch">

            <Header>
                <MudTh>Acciones</MudTh>
                <MudTh><MudTableSortLabel SortLabel="PkIdUsuario" T="UsuarioResponse">ID</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="NombreCompleto" T="UsuarioResponse">Nombre Completo</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="Email" T="UsuarioResponse">Email</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="TelefonoUsuario" T="UsuarioResponse">Teléfono</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="PayrollId" T="UsuarioResponse">Usuario</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="NombreEmpresa" T="UsuarioResponse">Empresa</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="NumeroSocial" T="UsuarioResponse">NSS</MudTableSortLabel></MudTh>
            </Header>

            <Row Context="usuario">
                <MudTd>
                    <MudTooltip Text="Editar usuario">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Visible="@CanUpdate"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       OnClick="@(() => EditItem(usuario.PkIdUsuario))" />
                    </MudTooltip>
                    <MudTooltip Text="Eliminar usuario">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Visible="@CanDelete"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="@(() => DeleteItem(usuario.PkIdUsuario))" />
                    </MudTooltip>
                </MudTd>
                <MudTd>@usuario.PkIdUsuario</MudTd>
                <MudTd>@usuario.NombreCompleto</MudTd>
                <MudTd>@usuario.Email</MudTd>
                <MudTd>@usuario.TelefonoUsuario</MudTd>
                <MudTd>@usuario.PayrollId</MudTd>
                <MudTd>@usuario.NombreEmpresa</MudTd>
                <MudTd>@usuario.NumeroSocial</MudTd>
            </Row>
        </GenericTable>
    </MudContainer>
</AccessVerification>

@code {
    private GenericTable<UsuarioResponse> table = null!;

    protected override string ModuleName => "configuracion";
    protected override string SubModuleName => "usuarios";
    protected override Type CreateDialogType => typeof(CrearUsuario);
    protected override Type EditDialogType => typeof(EditarUsuario);
    protected override Type DeleteDialogType => typeof(EliminarUsuario);

    protected override string GetDefaultSortLabel() => "NombreCompleto";

    protected override IEnumerable<object> MapToExcelData(IEnumerable<UsuarioResponse> items)
    {
        return items.Select(u => new
        {
            ID = u.PkIdUsuario,
            Nombre_Completo = u.NombreCompleto,
            Email = u.Email,
            Telefono = u.TelefonoPrincipal,
            Departamento = u.NombreDepartamento,
            Empresa = u.NombreEmpresa,
            Sucursal = u.NombreSucursal
        });
    }

    protected override async Task CreateItem()
    {
        await base.CreateItem();
        await table.ReloadData();
    }

    protected override async Task EditItem(int id)
    {
        await base.EditItem(id);
        await table.ReloadData();
    }

    protected override async Task DeleteItem(int id)
    {
        await base.DeleteItem(id);
        await table.ReloadData();
    }
}