@using System.ComponentModel.DataAnnotations
@using EG.Web.Contracs
@using EG.Web.Contracs.Configuration
@using EG.Web.Models.Configuration
@using EG.Web.Services
@using EG.Web.Services.Configuration
@using Microsoft.AspNetCore.Components.Forms
@using MudBlazor


@inject IJSRuntime _jsRuntime

@inject ISucursalService sucursalService
@inject IGenericCrudService<UsuarioResponse> _service
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar


<MudDialog>
    <DialogContent>
        <!-- Indicador de carga -->
        <MudOverlay Visible="@loading" Fixed="true" ZIndex="10">
            <div class="d-flex flex-column align-center justify-center" style="height:100%">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                <MudText Class="mt-4">Cargando...</MudText>
            </div>
        </MudOverlay>
        <MudPaper Class="pa-6 my-6" Elevation="6">
            <MudGrid GutterSize="2">


                <!-- Información del usuario -->
         
                    <MudForm @ref="form">

                        <MudCard Elevation="2" Class="pa-2">
                           
                            <MudDivider Class="mb-4" />

                            <MudForm>
                                <MudGrid GutterSize="2">
                                    <!-- Nombre completo -->
                                    <MudItem xs="12" md="6">
                                        <MudTextField Label="Nombre" @bind-Value="userProfile.NombreUsuario" Required="true" />
                                    </MudItem>
                                    <MudItem xs="12" md="6">
                                        <MudTextField Label="Apellido Paterno" @bind-Value="userProfile.ApellidoPaterno" Required="true" />
                                    </MudItem>
                                    <MudItem xs="12" md="6">
                                        <MudTextField Label="Apellido Materno" @bind-Value="userProfile.ApellidoMaterno" />
                                    </MudItem>

                                    <!-- Sucursal -->
                                    <MudItem xs="12" md="6">
                                        <MudSelect Label="Sucursal" @bind-Value="userProfile.PkidSucursal" Required="true">
                                            <MudSelectItem Value="0">Seleccione una Sucursal</MudSelectItem>
                                            @foreach (var sucursal in listadoSucursales)
                                            {
                                            <MudSelectItem Value="@sucursal.PkidSucursal">@sucursal.Nombre</MudSelectItem>
                                            }
                                        </MudSelect>
                                    </MudItem>

                                    <!-- Contacto -->
                                    <MudItem xs="12" md="6">
                                        <MudTextField Label="Email" @bind-Value="userProfile.Email" InputType="InputType.Email" Required="true" />
                                    </MudItem>
                                    <MudItem xs="12" md="6">
                                        <MudTextField Label="Teléfono" @bind-Value="userProfile.TelefonoPrincipal" />
                                    </MudItem>

                                    <!-- Dirección -->
                                    <MudItem xs="12" md="6">
                                        <MudTextField Label="Dirección 1" @bind-Value="userProfile.Direccion1" />
                                    </MudItem>
                                    <MudItem xs="12" md="6">
                                        <MudTextField Label="Dirección 2" @bind-Value="userProfile.Direccion2" />
                                    </MudItem>
                                    <MudItem xs="12" md="4">
                                        <MudTextField Label="Código Postal" @bind-Value="userProfile.CodigoPostalUsuario" />
                                    </MudItem>

                                    <!-- Campos adicionales -->
                                    <MudItem xs="12" md="4">
                                        <MudTextField Label="Payroll ID" @bind-Value="userProfile.PayrollId" />
                                    </MudItem>
                                    <MudItem xs="12" md="4">
                                        <MudTextField Label="Número Social" @bind-Value="userProfile.NumeroSocial" />
                                    </MudItem>
                                    <MudItem xs="12" md="4">
                                        <MudTextField Label="Gafete" @bind-Value="userProfile.Gafete" />
                                    </MudItem>

                                    <!-- Estado y Género -->
                                    <MudPaper Class="pa-4 mb-4" Elevation="2" Style="border-radius: 8px;">
                                        <MudText Class="mb-2">Estado del Usuario</MudText>
                                        <MudDivider Class="mb-3" />
                                        <MudRadioGroup @bind-Value="userProfile.UsuarioActivo">
                                            <MudRadio Value="true" Color="Color.Primary" Dense="true">Activo</MudRadio>
                                            <MudRadio Value="false" Color="Color.Secondary" Dense="false">Inactivo</MudRadio>
                                        </MudRadioGroup>
                                    </MudPaper>
                                    <MudPaper Class="pa-4 mb-4" Elevation="2" Style="border-radius: 8px;">
                                        <MudText Class="mb-2">Género</MudText>
                                        <MudDivider Class="mb-3" />
                                        <MudRadioGroup @bind-Value="userProfile.Sexo">
                                            <MudRadio Value="true" Color="Color.Primary" Dense="true">Femenino</MudRadio>
                                            <MudRadio Value="false" Color="Color.Secondary" Dense="false">Masculino</MudRadio>
                                        </MudRadioGroup>
                                    </MudPaper>
                                </MudGrid>

                                <!-- Botones -->
                                <div class="d-flex justify-end mt-6">
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" OnClick="GuardarCambiosAsync">
                                        Guardar cambios
                                    </MudButton>
                                </div>
                            </MudForm>
                        </MudCard>
                    </MudForm>
              
            </MudGrid>

        </MudPaper>
    </DialogContent>
</MudDialog>


@code {

    [Parameter] public int UsuarioId { get; set; }

    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;

    private MudForm form = new MudForm();

    private bool loading = false;

    private IList<SucursalResponse> listadoSucursales = new List<SucursalResponse>();

    public UsuarioResponse userProfile { get; set; } = new();

    private bool isLoading = false;

    // Propiedad intermedia para el binding
    private void OnSelectedGeneroChanged(bool selectedOption)
    {
        userProfile.Sexo = selectedOption;
    }

    protected override async Task OnInitializedAsync()
    {
        loading = true;
        try
        {
            await LoadData();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar datos: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadData()
    {
        try
        {
            var usuarioResponse = await _service.GetByIdAsync(UsuarioId);

            if (usuarioResponse == null || !usuarioResponse.Success || usuarioResponse.Data == null)
            {
                var errorMessage = usuarioResponse?.Message ?? "Error al cargar usuario";
                Console.WriteLine($"⚠️ {errorMessage}");
                Snackbar.Add(errorMessage, Severity.Error);
                return;
            }

            userProfile = usuarioResponse.Data;
            Console.WriteLine($"✅ Usuario cargado: ID {userProfile.PkIdUsuario}, Nombre: {userProfile.NombreCompleto}, Iniciales: {userProfile.Iniciales}");

            var sucursalResponse = await sucursalService.GetAllSucursales();

            if (sucursalResponse == null || !sucursalResponse.Success || sucursalResponse.Items == null || !sucursalResponse.Items.Any())
            {
                var errorMessage = sucursalResponse?.Message ?? "Error al cargar sucursales";
                Console.WriteLine($"⚠️ {errorMessage}");
                Snackbar.Add(errorMessage, Severity.Error);
                return;
            }

            listadoSucursales = sucursalResponse.Items;
            Console.WriteLine($"✓ Se cargaron {listadoSucursales.Count} sucursales");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error al cargar datos: {ex.Message}\n{ex.StackTrace}");
            Snackbar.Add($"Error al cargar datos: {ex.Message}", Severity.Error);
        }
    }

    private async Task GuardarCambiosAsync()
    {
        loading = true;
        StateHasChanged();

        try
        {
            await form.Validate();

            if (!form.IsValid)
            {
                Snackbar.Add("Por favor, completa todos los campos requeridos.", Severity.Warning);
                loading = false;
                return;
            }

            try
            {
                var response = await _service.UpdateAsync(userProfile, userProfile.PkIdUsuario);

                if (response != null && response.Success)
                {
                    var message = !string.IsNullOrEmpty(response.Message)
                        ? response.Message
                        : $"✅ Usuario actualizado: ID {userProfile.PkIdUsuario}, Nombre: {userProfile.NombreUsuario}, Iniciales: {userProfile.Iniciales}";

                    Console.WriteLine(message);
                    Snackbar.Add(message, Severity.Success);
                    MudDialog.Close(DialogResult.Ok(true));
                }
                else
                {
                    var errorMessage = response?.Message ?? "Error al guardar usuario";
                    Console.WriteLine($"❌ {errorMessage}");
                    Snackbar.Add(errorMessage, Severity.Error);
                    loading = false;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Error interno al guardar: {ex.Message}\n{ex.StackTrace}");
                Snackbar.Add($"Error al guardar: {ex.Message}", Severity.Error);
                loading = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error al validar formulario: {ex.Message}\n{ex.StackTrace}");
            Snackbar.Add($"Error al guardar: {ex.Message}", Severity.Error);
            loading = false;
        }
        finally
        {
            StateHasChanged();
        }
    }

    private void Cancelar()
    {
        MudDialog.Cancel();
    }

}