@using System.ComponentModel.DataAnnotations
@using EG.Web.Models.Configuration
@using EG.Web.Services
@using EG.Web.Services.Configuration
@using Microsoft.AspNetCore.Components.Forms
@using MudBlazor


@inject IJSRuntime _jsRuntime

@inject EmpresaService empresaService
@inject ProfileService profileService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar



<MudDialog MaxWidth="MaxWidth.Medium" FullWidth="true" CloseOnEscapeKey="false">
    <DialogContent>
        <!-- Indicador de carga -->
        <MudOverlay Visible="@loading" Fixed="true" ZIndex="10">
            <div class="d-flex flex-column align-center justify-center" style="height:100%">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                <MudText Class="mt-4">Cargando...</MudText>
            </div>
        </MudOverlay>
        <MudPaper Class="pa-6 my-6" Elevation="6">
            <MudGrid GutterSize="2">
                <!-- Información del usuario -->
                <MudForm @ref="form">

                    <MudCard Elevation="2" Class="pa-2">
                        <MudDivider Class="mb-4" />
                        <MudForm>
                            <MudGrid GutterSize="2">
                                <!-- Nombre completo -->
                                <MudItem xs="12" md="6">
                                    <MudTextField Label="Nombre" @bind-Value="userProfile.Nombre" Required="true" />
                                </MudItem>
                                <MudItem xs="12" md="6">
                                    <MudTextField Label="Apellido Paterno" @bind-Value="userProfile.ApellidoPaterno" Required="true" />
                                </MudItem>
                                <MudItem xs="12" md="6">
                                    <MudTextField Label="Apellido Materno" @bind-Value="userProfile.ApellidoMaterno" />
                                </MudItem>

                                <!-- Empresa -->
                                <MudItem xs="12" md="6">
                                    <MudSelect Label="Empresa"
                                               @bind-Value="userProfile.FkidEmpresaSis"
                                               Required="true"
                                               RequiredError="Debe seleccionar una empresa"
                                               ValidationPattern="@validationPattern"
                                               ValidationError="Debe seleccionar una empresa válida">
                                        <MudSelectItem Value="0">Seleccione una empresa</MudSelectItem>
                                        @foreach (var empresa in listadoEmpresas.Where(e => e.Activo))
                                        {
                                            <MudSelectItem Value="@empresa.PkidEmpresa">@empresa.Nombre</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>

                                <!-- Contacto -->
                                <MudItem xs="12" md="6">
                                    <MudTextField Label="Email" @bind-Value="userProfile.Email" InputType="InputType.Email" Required="true" />
                                </MudItem>
                                <MudItem xs="12" md="6">
                                    <MudTextField Label="Teléfono" @bind-Value="userProfile.Telefono" />
                                </MudItem>

                                <!-- Dirección -->
                                <MudItem xs="12" md="6">
                                    <MudTextField Label="Dirección 1" @bind-Value="userProfile.Direccion1" />
                                </MudItem>
                                <MudItem xs="12" md="6">
                                    <MudTextField Label="Dirección 2" @bind-Value="userProfile.Direccion2" />
                                </MudItem>
                                <MudItem xs="12" md="4">
                                    <MudTextField Label="Código Postal" @bind-Value="userProfile.CodigoPostal" />
                                </MudItem>

                                <!-- Campos adicionales -->
                                <MudItem xs="12" md="4">
                                    <MudTextField Label="Payroll ID" @bind-Value="userProfile.PayrollId" />
                                </MudItem>
                                <MudItem xs="12" md="4">
                                    <MudTextField Label="Número Social" @bind-Value="userProfile.NumeroSocial" />
                                </MudItem>
                                <MudItem xs="12" md="4">
                                    <MudTextField Label="Gafete" @bind-Value="userProfile.Gafete" />
                                </MudItem>

                                <!-- Estado y Género -->
                                <MudPaper Class="pa-4 mb-4" Elevation="2" Style="border-radius: 8px;">
                                    <MudText Class="mb-2">Estado del Usuario</MudText>
                                    <MudDivider Class="mb-3" />
                                    <MudRadioGroup @bind-Value="userProfile.Activo">
                                        <MudRadio Value="true" Color="Color.Primary" Dense="true">Activo</MudRadio>
                                        <MudRadio Value="false" Color="Color.Secondary" Dense="false">Inactivo</MudRadio>
                                    </MudRadioGroup>
                                </MudPaper>
                                <MudPaper Class="pa-4 mb-4" Elevation="2" Style="border-radius: 8px;">
                                    <MudText Class="mb-2">Género</MudText>
                                    <MudDivider Class="mb-3" />
                                    <MudRadioGroup @bind-Value="userProfile.Sexo">
                                        <MudRadio Value="true" Color="Color.Primary" Dense="true">Femenino</MudRadio>
                                        <MudRadio Value="false" Color="Color.Secondary" Dense="false">Masculino</MudRadio>
                                    </MudRadioGroup>
                                </MudPaper>
                            </MudGrid>

                            <!-- Botones -->
                            <div class="d-flex justify-end mt-6">
                                <MudButton Variant="Variant.Text" Color="Color.Secondary" Class="mr-2" OnClick="Cancelar">
                                    Cancelar
                                </MudButton> 
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" OnClick="GuardarCambiosAsync">
                                    Guardar cambios
                                </MudButton>
                            </div>
                        </MudForm>
                    </MudCard>
                </MudForm>
            </MudGrid>
        </MudPaper>
    </DialogContent>
</MudDialog>


@code {

    [Parameter] public int UsuarioId { get; set; }

    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;

    private MudForm form = new MudForm();

    private bool loading = false;

    public List<EmpresaResponse> listadoEmpresas { get; set; } = new();

    public UsuarioResponse userProfile { get; set; } = new();

    private string validationPattern = "^(?!0$).*"; // Expresión regular que no permite solo "0"

    // Propiedad intermedia para el binding
    private void OnSelectedGeneroChanged(bool selectedOption)
    {
        userProfile.Sexo = selectedOption;
    }

    protected override async Task OnInitializedAsync()
    {
        loading = true;
        try
        {
            await LoadData();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar datos: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadData()
    {
        listadoEmpresas = await empresaService.GetEmpresa();
    }

    private async Task GuardarCambiosAsync()
    {
        bool result;
        string msg;
        loading = true;
        try
        {
            // // Simular operación de guardado
            await form.Validate();

            if (!form.IsValid)
            {
                Snackbar.Add("Por favor, completa todos los campos requeridos.", Severity.Warning);
                return;
            }

            try
            {
                userProfile.Iniciales = GetIniciales(userProfile);
                (result, msg) = await profileService.CreateProfileUser(userProfile);

                Snackbar.Add(msg, result ? Severity.Success : Severity.Error);

                MudDialog.Close(DialogResult.Ok(result));
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error al guardar: {ex.Message}", Severity.Error);
            }

        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al guardar: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void Cancelar()
    {
        MudDialog.Cancel();
    }


    public string GetIniciales(UsuarioResponse userProfile)
    {
       
        var iniciales = string.Empty;

        if (!string.IsNullOrWhiteSpace(userProfile.Nombre))
            iniciales += char.ToUpper(userProfile.Nombre.Trim()[0]);

        if (!string.IsNullOrWhiteSpace(userProfile.ApellidoPaterno))
            iniciales += char.ToUpper(userProfile.ApellidoPaterno.Trim()[0]);

        if (!string.IsNullOrWhiteSpace(userProfile.ApellidoMaterno))
            iniciales += char.ToUpper(userProfile.ApellidoMaterno.Trim()[0]);

            return iniciales;
        
    }
}

