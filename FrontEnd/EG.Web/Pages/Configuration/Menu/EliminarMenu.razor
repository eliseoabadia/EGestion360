@using EG.Domain.DTOs.Responses
@using EG.Web.Contracs
@using EG.Web.Models.Configuration
@using MudBlazor

@inject IGenericCrudService<MenuItemsResponse> _service
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6" Color="Color.Error">
            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Class="mr-2" />
            Confirmar Eliminación
        </MudText>
    </TitleContent>

    <DialogContent>
        @if (cargando)
        {
            <MudProgressCircular Indeterminate="true" Class="ma-4" />
        }
        else
        {
            <MudStack Spacing="3">
                <MudAlert Severity="Severity.Warning" Variant="Variant.Filled">
                    ¿Está seguro que desea eliminar este menú?
                </MudAlert>

                @if (menu != null)
                {
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary">
                            <strong>@menu.Nombre</strong>
                        </MudText>

                        <MudDivider Class="my-2" />

                        <MudGrid Spacing="2">
                            <MudItem xs="6">
                                <MudText Typo="Typo.caption">ID:</MudText>
                                <MudText Typo="Typo.body2">@menu.PkidMenu</MudText>
                            </MudItem>

                            <MudItem xs="6">
                                <MudText Typo="Typo.caption">Tipo:</MudText>
                                <MudText Typo="Typo.body2">@(menu.Tipo == 1 ? "Contenedor" : "Item")</MudText>
                            </MudItem>

                            <MudItem xs="6">
                                <MudText Typo="Typo.caption">Orden:</MudText>
                                <MudText Typo="Typo.body2">@menu.Orden</MudText>
                            </MudItem>

                            <MudItem xs="6">
                                <MudText Typo="Typo.caption">Estado:</MudText>
                                <MudBadge Color="@(menu.Activo? Color.Success: Color.Error)"
                                          Variant="Variant.Filled"
                                          Size="Size.Small">
                                    @(menu.Activo ? "Activo" : "Inactivo")
                                </MudBadge>
                            </MudItem>
                        </MudGrid>

                        @if (menu.FkidMenuSis.HasValue)
                        {
                            <MudText Typo="Typo.caption" Class="mt-2">
                                Menú Padre: <strong>@menu.NombreMenuPadre</strong>
                            </MudText>
                        }

                        @if (tieneHijos)
                        {
                            <MudAlert Severity="Severity.Error" Class="mt-3" Variant="Variant.Outlined">
                                <MudText>
                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" />
                                    Este menú tiene submenús. No se puede eliminar.
                                </MudText>
                            </MudAlert>
                        }
                    </MudPaper>
                }
            </MudStack>
        }
    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text"
                   Color="Color.Default"
                   OnClick="Cancelar">
            Cancelar
        </MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Error"
                   OnClick="Eliminar"
                   Disabled="@(cargando || tieneHijos)"
                   StartIcon="@Icons.Material.Filled.Delete">
            Eliminar
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public int MenuId { get; set; }

    private MenuItemsResponse? menu;
    private bool cargando = true;
    private bool tieneHijos = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarMenu();
    }

    private async Task CargarMenu()
    {
        try
        {
            cargando = true;
            var response = await _service.GetByIdAsync(MenuId);

            if (response != null && response.Success && response.Data != null)
            {
                menu = response.Data;
                await VerificarHijos();
            }
            else
            {
                Snackbar.Add(response?.Message ?? "Error al cargar el menú", Severity.Error);
                MudDialog.Cancel();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar: {ex.Message}", Severity.Error);
            MudDialog.Cancel();
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task VerificarHijos()
    {
        try
        {
            var response = await _service.GetAllAsync();
            if (response != null && response.Success)
            {
                tieneHijos = response.Items?.Any(x => x.FkidMenuSis == MenuId) ?? false;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al verificar submenús: {ex.Message}", Severity.Warning);
        }
    }

    private async Task Eliminar()
    {
        try
        {
            if (tieneHijos)
            {
                Snackbar.Add("No se puede eliminar un menú que tiene submenús", Severity.Error);
                return;
            }

            var response = await _service.DeleteAsync(MenuId);
            if (response != null && response.Success)
            {
                Snackbar.Add("Menú eliminado exitosamente", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add(response?.Message ?? "Error al eliminar el menú", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al eliminar: {ex.Message}", Severity.Error);
        }
    }

    private void Cancelar()
    {
        MudDialog.Cancel();
    }
}